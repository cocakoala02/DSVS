<!DOCTYPE html> <!-- HTML5 文档类型声明 -->
<html lang="zh"> <!-- 文档语言设为中文 -->
<head> <!-- 文档头部 -->
  <meta charset="UTF-8" /> <!-- 字符编码为 UTF-8 -->
  <title>DSVS Survey 查询页面</title> <!-- 页面标题 -->
  <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- 移动端视口设置 -->
  <style> /* 页面内联样式开始 */
    :root { /* CSS 变量：主题色与基础色 */
      --ok: #0c8a0c; /* 成功状态颜色 */
      --err: #c62828; /* 错误状态颜色 */
      --muted: #666; /* 次级文字颜色 */
      --card: #fff; /* 卡片背景色 */
      --bg: #f7f7f9; /* 页面背景色 */
      --border: #ddd; /* 边框颜色 */
    }
    * { box-sizing: border-box; } /* 统一盒模型，包含内边距与边框 */
    body { /* 页面主体样式 */
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial; /* 字体族 */
      padding: 28px; /* 页面内边距 */
      background: var(--bg); /* 背景色使用变量 */
      color: #111; /* 文字主色 */
      line-height: 1.5; /* 行高 */
      max-width: 1000px; /* 内容最大宽度 */
      margin: 0 auto; /* 居中 */
    }
    h2 { margin: 0 0 12px; } /* 二级标题下边距 */
    .row { margin-bottom: 18px; } /* 行间距 */
    label { display: block; font-weight: 600; margin-bottom: 6px; } /* 表单标签样式 */
    input[type="text"], textarea { /* 文本输入与多行输入通用样式 */
      width: 100%; /* 宽度占满 */
      font-size: 14px; /* 字号 */
      padding: 10px 12px; /* 内边距 */
      border: 1px solid var(--border); /* 边框 */
      border-radius: 8px; /* 圆角 */
      background: #fff; /* 背景白色 */
    }
    textarea { /* 文本域专属样式 */
      min-height: 120px; /* 最小高度 */
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; /* 等宽字体 */
      resize: vertical; /* 允许垂直方向缩放 */
    }
    .controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; } /* 控制区布局 */
    button { /* 按钮样式 */
      padding: 10px 18px; /* 内边距 */
      font-size: 15px; /* 字号 */
      cursor: pointer; /* 指针样式 */
      border-radius: 8px; /* 圆角 */
      border: 1px solid #cfcfcf; /* 边框 */
      background: #fff; /* 背景白色 */
    }
    button[disabled] { opacity: .6; cursor: not-allowed; } /* 禁用按钮状态 */
    .hint { color: var(--muted); font-size: 13px; } /* 提示文字样式 */
    .result-card { /* 结果卡片容器 */
      border: 1px solid var(--border); /* 边框 */
      border-radius: 10px; /* 圆角 */
      background: var(--card); /* 背景色 */
      padding: 14px; /* 内边距 */
      margin-bottom: 16px; /* 下边距 */
    }
    .result-title { /* 结果标题样式 */
      font-weight: 600; /* 加粗 */
      margin-bottom: 8px; /* 下边距 */
    }
    pre { /* 结果显示区（保留格式） */
      margin: 0; /* 去除外边距 */
      white-space: pre-wrap; /* 保留空白并自动换行 */
      word-break: break-word; /* 长词换行 */
      font-family: ui-monospace, Menlo, Consolas, monospace; /* 等宽字体 */
      font-size: 13px; /* 字号 */
    }
    .badge { /* 状态徽标样式 */
      display: inline-block; /* 行内块 */
      padding: 2px 8px; /* 内边距 */
      border-radius: 999px; /* 胶囊圆角 */
      font-size: 12px; /* 字号 */
      border: 1px solid var(--border); /* 边框 */
      background: #fafafa; /* 背景 */
      margin-left: 8px; /* 左外边距 */
      vertical-align: middle; /* 垂直对齐 */
    }
    .ok { color: var(--ok); border-color: #b6e0b6; background: #f3fbf3; } /* 成功徽标样式 */
    .err { color: var(--err); border-color: #f4c7c7; background: #fff6f6; } /* 失败徽标样式 */
  </style> <!-- 内联样式结束 -->
</head> <!-- 头部结束 -->
<body> <!-- 页面主体开始 -->
  <h2>DSVS SQL 查询页面</h2> <!-- 页面主标题 -->

  <div class="row"> <!-- SQL 输入区容器 -->
    <label for="sqlInput">请输入 SQL 查询语句：</label> <!-- SQL 输入标签 -->
    <textarea id="sqlInput" placeholder="例如：SELECT SUM(visits) FROM statistics_experiment_data"></textarea> <!-- SQL 输入框 -->
    <div class="hint">提示：按 <kbd>Ctrl</kbd>/<kbd>⌘</kbd> + <kbd>Enter</kbd> 可直接提交</div> <!-- 快捷键提示 -->
  </div> <!-- SQL 输入区结束 -->

  <div class="row"> <!-- CropID 输入区容器 -->
    <label for="cropInput">请输入 CropID（用逗号分隔）：</label> <!-- CropID 输入标签 -->
    <input id="cropInput" type="text" placeholder="例如：id1,id2,id3" /> <!-- CropID 文本输入框 -->
    <div class="hint">支持中英文逗号，会自动去重与去空格</div> <!-- 输入说明 -->
  </div> <!-- CropID 输入区结束 -->

  <div class="row controls"> <!-- 按钮与加载状态容器 -->
    <button id="submitBtn">查询</button> <!-- 提交查询按钮 -->
    <span id="loading" class="hint" style="display:none">正在查询…</span> <!-- 加载中提示，默认隐藏 -->
  </div> <!-- 控制区结束 -->

  <div class="result-card"> <!-- 查询结果卡片 -->
    <div class="result-title">查询结果 <span id="statusBadge" class="badge">等待查询</span></div> <!-- 标题与状态徽标 -->
    <pre id="queryResult">（等待查询…）</pre> <!-- 查询结果展示区 -->
  </div> <!-- 查询结果卡片结束 -->

  <div class="result-card"> <!-- 验证结果卡片 -->
    <div class="result-title">验证结果</div> <!-- 验证结果标题 -->
    <pre id="validationResult">（等待响应…）</pre> <!-- 验证结果展示区 -->
  </div> <!-- 验证结果卡片结束 -->

<script> // 页面脚本开始
(function () { // IIFE：自执行函数，避免污染全局作用域
  // 若与后端同源部署保持空；若跨域，请改为完整地址（如 http://localhost:8088）
  const API_BASE = "http://localhost:8088"; // API 基础路径（同源为空字符串）
  const ENDPOINT = API_BASE + "/survey"; // 接口路径

  const $ = (id) => document.getElementById(id); // 简易选择器
  const sqlInput = $("sqlInput"); // SQL 文本域引用
  const cropInput = $("cropInput"); // CropID 输入框引用
  const submitBtn = $("submitBtn"); // 提交按钮引用
  const resultBox = $("queryResult"); // 结果展示区域
  const validationBox = $("validationResult"); // 验证展示区域
  const loading = $("loading"); // 加载提示引用
  const statusBadge = $("statusBadge"); // 状态徽标引用

  function setLoadingState(isLoading) { // 切换加载状态（禁用按钮/切换提示）
    loading.style.display = isLoading ? "inline" : "none"; // 显示/隐藏“正在查询…”
    submitBtn.disabled = isLoading; // 禁用/启用按钮
  }

  function pretty(val) { // 结果美化：对象转 JSON、字符串原样
    if (val == null) return "(null)"; // 处理 null/undefined
    if (typeof val === "string") return val; // 字符串直接返回
    try { return JSON.stringify(val, null, 2); } // 对象/数组格式化
    catch { return String(val); } // 兜底转换
  }

  function setBadge(ok, textWhenOk = "成功", textWhenErr = "失败") { // 设置状态徽标
    statusBadge.classList.remove("ok", "err"); // 先移除状态类
    if (ok) { // 成功分支
      statusBadge.textContent = textWhenOk; // 显示“成功”或自定义成功文本
      statusBadge.classList.add("ok"); // 添加成功样式
    } else { // 失败/进行中分支
      statusBadge.textContent = textWhenErr; // 显示“失败”或自定义文本
      statusBadge.classList.add("err"); // 添加失败样式
    }
  }

  function parseCropIDs(raw) { // 将输入的字符串解析为 CropID 数组
    // 以中英文逗号分隔，去两端空格，过滤空串，最后用 Set 去重
    const parts = raw
      .split(/[,，]/g) // 按逗号拆分
      .map(s => s.trim()) // 去除空格
      .filter(Boolean); // 过滤空字符串
    return Array.from(new Set(parts)); // 去重并返回数组
  }

  async function submitQuery() { // 提交查询主函数（异步）
    const sql = sqlInput.value.trim(); // 读取 SQL
    const cropRaw = cropInput.value.trim(); // 读取 CropID 原始输入

    if (!sql) { // 校验 SQL 不能为空
      alert("请输入 SQL 查询语句！"); // 弹窗提示
      sqlInput.focus(); // 聚焦到 SQL 输入框
      return; // 终止提交
    }

    const cropID = parseCropIDs(cropRaw); // 解析得到 CropID 数组

    setLoadingState(true); // 进入加载状态
    resultBox.textContent = "（查询中…）"; // 更新结果提示
    validationBox.textContent = "（等待响应…）"; // 更新验证提示
    setBadge(false, "进行中", "进行中"); // 徽标显示进行中（使用失败样式占位）

    // 兼容后端可能使用的两种 JSON 键：crop_id 与 CropID；值相同
    const payload = { sql, crop_id: cropID, CropID: cropID }; // 组装请求体

    try { // 网络请求尝试
      const resp = await fetch(ENDPOINT, { // 发送请求
        method: "POST", // POST 方法
        headers: { "Content-Type": "application/json" }, // JSON 请求头
        // credentials: "include", // 如需携带 Cookie 且后端允许，解开此行
        body: JSON.stringify(payload) // 序列化请求体
      });

      const text = await resp.text(); // 以文本读取响应体（兼容非 JSON）
      let json; // 解析结果变量
      try { json = text ? JSON.parse(text) : {}; } // 尝试解析为 JSON
      catch { json = { raw: text }; } // 解析失败则保留原文

      if (resp.ok) { // HTTP 2xx 成功分支
        resultBox.textContent = pretty(json.data ?? json.raw ?? "(无数据)"); // 显示 data 或 raw
        //const maybeNum = Number(json.data);
        //if (Number.isFinite(maybeNum)) {
        //  resultBox.textContent = maybeNum.toFixed(2);  // 总是 2 位，如 17.00
        //} else {
        //  resultBox.textContent = pretty(json.data ?? json.raw ?? "(无数据)");
        //}

        // const succ = (json.success === true || json.success === "true"); // 兼容布尔/字符串
        const valres = json.valres;
        validationBox.textContent = valres ? "验证通过" : "验证未通过";
        // validationBox.textContent = json. ? "验证通过" : "验证未通过"; // 展示验证结果
        setBadge(valres); // 徽标切换成功/失败
      } else { // HTTP 非 2xx 分支
        const errMsg =
          (json && (json.data || json.message || json.error)) || // 从 JSON 中取错误字段
          text || // 否则使用原始文本
          `HTTP ${resp.status}`; // 再否则显示状态码
        resultBox.textContent = `查询失败：${pretty(errMsg)}`; // 显示错误详情
        validationBox.textContent = `错误码：${resp.status}`; // 显示 HTTP 状态码
        setBadge(false); // 徽标改为失败
      }
    } catch (e) { // 捕获网络或运行时异常
      resultBox.textContent = "请求失败：" + (e?.message || e); // 显示异常信息
      validationBox.textContent = "请检查网络连接或后端服务状态。"; // 提示检查服务
      setBadge(false, "", "网络/服务异常"); // 徽标显示异常状态文案
    } finally { // 无论成功失败，最终执行
      setLoadingState(false); // 退出加载状态
    }
  }

  submitBtn.addEventListener("click", submitQuery); // 点击按钮触发提交
  sqlInput.addEventListener("keydown", (e) => { // SQL 输入框快捷键监听
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") submitQuery(); // Ctrl/⌘+Enter 提交
  });
  cropInput.addEventListener("keydown", (e) => { // CropID 输入框快捷键监听
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") submitQuery(); // Ctrl/⌘+Enter 提交
  });
})(); // 自执行函数结束
</script> <!-- 页面脚本结束 -->
</body> <!-- 页面主体结束 -->
</html> <!-- 文档结束 -->
